# 第五章 中央处理器

## 5.1 CPU的功能和结构

> * CPU需要具有哪些功能？
> * 对应这些功能需要具有怎样的结构？

### 5.1.1 CPU的功能

1. CPU具有的功能
   * 指令控制：完成取指令、分析指令和执行指令的操作，即对程序的顺序控制
   * 操作控制：一条指令功能的完成往往需要一系列操作信号的组合来实现。CPU负责产生并管理这些操作信号，并将这些操作信号发送到对应的部件，从而控制部件完成指令要求的动作、响应等
   * 时间控制：就具体的一条指令而言，其内部一系列的操作信号需要加以时间控制；对宏观上的所有指令系统而言，时间控制需要安排每条指令执行的先后顺序
   * 数据加工：对数据进行算术运算和逻辑运算。完成数据的加工处理，是CPU的根本任务
   * 中断处理：对计算机运行过程中出现的**异常情况**或**特殊请求**进行处理

2. 功能分摊

    运算器和控制器是CPU的两大核心部件。上述列出的五个功能自然也就要分摊到这两个部件上

    运算器：顾名思义，需要对数据进行加工

    控制器：协调并控制计算机各部件执行程序的指令序列，协调和指挥整个计算机系统的运行。基本功能包括取指令、分析指令和执行指令

    * 取指令：**自动**形成指令地址；**自动**发出取指令的命令
    * 分析指令：指令由操作码和地址码两部分组成。因此分析指令就是对操作码译码(分析当前指令要完成的操作)、产生操作数的有效地址(获取操作对象)
    * 执行指令：根据上一步得到的「操作命令」和「操作数地址」，形成操作信号的控制序列，并控制相关部件(存储器、运算器和I/O设备等)完成相应的操作
    * 中断处理：管理总线和输入输出；处理异常情况和特殊请求

### 5.1.2 CPU的结构

根据运算器和控制器的功能分析其应具有怎样的结构

#### 运算器的结构

算术逻辑单元：运算器的核心是算术逻辑运算单元(ALU),其主要功能就是进行算术或逻辑运算。其特点是它是一个组合逻辑电路，一旦输入信号确定后，就会产生相应的输出信号

![ALU示意图](images/2023-01-17-11-22-35.png)

通用寄存器组：运算器还需要提供一些通用的寄存器，以存储操作数、运算过程中产生的中间结果以及各种地址信息

![通用寄存器组示意图](images/2023-01-17-11-23-25.png)

ALU与通用寄存器之间的连接：ALU与寄存器之间可以传输数据

![专用数据通路](images/2023-01-17-11-26-07.png)

专用数据通路方式：根据指令执行过程中数据和地址的流动方向来安排连接线路。也就是如果 $R_0$ 需要给ALU传输数据，则两者之间就要有连线

![专用数据通路](images/2023-01-17-11-30-04.png)

可以看到，如果直接用导线连接，相当于通用寄存器组同时且一直向ALU传输数据，这样ALU就无法判断当前需要处理的是哪一个数据。

![解法1](images/2023-01-17-11-32-47.png)

一个解决办法是使用多路选择器，如图所示，其电路符号是「MUX」，其通过控制信号 $C_1$ 和 $C_2$ 来选择当前哪个寄存器将数据传送给ALU。图中的例子是 $C_1$ 为00，则 $R_0$ 寄存器中的数据送入A，$C_2$ 为01，则寄存器 $R_1$ 中的数据送给B

![解法2](images/2023-01-17-11-38-01.png)

另外一个解决方法是采用三态门，如图所示，图中的一个小三角就表示一个三态门。每个三态门都有一个类似于 $R0_{out}$ 的信号控制

![解法2](images/2023-01-17-11-40-34.png)

专用数据通路方式的优缺点：由于每个寄存器都有专门的线路连接到ALU，因此性能较高，基本不存在数据冲突的现象；但也正是因为有专门的线路，因此结构复杂、硬件量大、不容易实现

CPU内部单总线方式：将所有寄存器的输入端和输出端都连接到一条公共的总线上

![CPU内部单总线](images/2023-01-18-17-23-59.png)

* 当 $R0_{in}$ 有效时，其他部件可以通过绿色的线将数据写入寄存器中
* 输出端采用了三态门的设计，当 $R0_{out}$ 有效时，寄存器可以通过蓝色的线将数据放入总线中

CPU内部单总线方式优缺点：结构简单(每个寄存器与总线之间只需要有一组相互连接的线路即可)，容易实现；但数据传输容易出现较多数据冲突的现象，性能较低 (例如将寄存器R0中的数据送给R1时，另外两个寄存器R2和R3就不能工作，必须等该过程结束后才可以)

![运算器的基本结构](images/2023-01-18-17-37-57.png)

* ALU也需要和CPU内部总线进行交流，因此我们可以分别连接两条线到A、B端，将其输出结果也通过一条线连接到CPU内部总线
  * 如果直接用两条线将CPU内部总线与ALU的输入端A、B相连，无法判断数据应该流入哪个输入端，因此可以在某条线路中加一个暂存寄存器，暂存寄存器可以用于暂存从主存送来的数据，该数据不能放在通用寄存器中，也就避免了将寄存器中原有的数据覆盖的情况
  * 同样，可以在输出端加一个暂存寄存器，并用一个三态门进行控制。在适当的时刻将其送入CPU内部总线，避免了破坏寄存器中原有数据的情况
  * 暂存寄存器除了可以用来暂存从主存中送来的数据外，还可以有移位、累加等功能即移位寄存器、累加寄存器，但累加寄存器一般会另外与CPU内部总线相连，如图所示。累加寄存器用来暂时存放ALU的运算结果
* 程序状态字寄存器(PSWR)：运算器工作时，在工作过程中产生的一些结论可以记录下来，比如本次运算是否溢出、是正数还是负数、是否为0等状态，如溢出标志(OP)、符号标志(SF)、零标志(ZF)、进位标志(CF)等。这些标志位通常分别由1位触发器保存。该寄存器是一个按位寻址的寄存器，也就是可以直接给出这些二进制位的地址
* 移位器：对运算结果进行移位计算
* 计数器：控制乘除运算的操作步数

![控制器的基本结构](images/2023-01-18-18-30-37.png)

* 程序计数器：需要获取指令后，CPU才能开始相关的工作。因此我们需要一个可以指出下一条指令在主存中的地址的寄存器，即**程序计数器**。CPU根据程序计数器(PC)中的内容取指令。并且要求程序计数器有**自增**的功能
* 指令寄存器：有了指令地址，通过CPU内总线将其送到指令寄存器中进行保存。指令又分为操作码和地址码，这两部分内容是要送到不同地方的。当我们需要获取操作对象时，只有地址码部分需要传回CPU内总线，再由总线传到相应的位置；操作码则是送入指令译码器中
* 指令译码器：接收操作码字段并进行译码，翻译成一系列控制信号，但并不是直接传给对应的部件(因为不同的部件有不同的执行顺序)
* 微操作信号发生器：接收指令译码器产生的初步信息，根据所要完成的任务以及时序系统提供的时间信号，还有目前整个系统所处的状态(来自程序状态字寄存器的标志信息)，整合上述所有信号来产生相应的控制信号。可以看到其输出端有绿线和蓝线，所以前面这些基本的控制信号都是由它发出的，以及一些发送到其他部件的信号
* 时序系统：用于产生各种时序信号
* 存储器地址寄存器：因为指令是可以来自存储器的，所以还需要两个特殊的寄存器即**存储器地址寄存器**和**存储器数据寄存器**。存储器地址寄存器用于存储所要访问的主存单元的地址。该寄存器接收来自程序计数器的指令地址信息，再通过外部的**地址总线**与主存进行交流
* 存储器数据寄存器：用于存放向主存中写入的信息或从主存中读出的信息。主存中提供的指令和数据是会先放到存储器数据寄存器当中的。该寄存器即与CPU内总线相连，又与数据总线相连，因此可以把需要的数据从主存中取出，也可以把内部的一些数据放到数据总线中

![运算器(左)和控制器(右)](images/2023-01-18-18-27-36.png)

## 5.2 指令的执行过程

## 5.3 数据通路的功能与基本结构

## 5.4 控制器的功能和工作原理

## 5.5 指令的流水线

